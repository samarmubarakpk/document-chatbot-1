<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Document AI Chatbot</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <style>
        .message-appear { animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .spinner { animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-50">
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useRef, useEffect } = React;
        const API_URL = 'http://localhost:8000';

        function MultiDocChatbot() {
            const [messages, setMessages] = useState([
                { role: 'assistant', content: 'Hello! I can analyze multiple technical documents. Upload PDFs and select which to search, or search all at once.', timestamp: new Date() }
            ]);
            const [input, setInput] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const [uploadedDocuments, setUploadedDocuments] = useState([]);
            const [selectedDocuments, setSelectedDocuments] = useState([]);
            const [isUploading, setIsUploading] = useState(false);
            const [showSources, setShowSources] = useState({});
            const [searchMode, setSearchMode] = useState('all');
            
            const fileInputRef = useRef(null);
            const messagesEndRef = useRef(null);

            useEffect(() => {
                messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
            }, [messages]);

            useEffect(() => {
                loadDocuments();
            }, []);

            const loadDocuments = async () => {
                try {
                    const response = await axios.get(`${API_URL}/documents`);
                    setUploadedDocuments(response.data.documents);
                } catch (error) {
                    console.error('Error loading documents:', error);
                }
            };

            const handleSendMessage = async () => {
                if (!input.trim() || isLoading) return;

                const userMessage = { role: 'user', content: input, timestamp: new Date() };
                setMessages(prev => [...prev, userMessage]);
                setInput('');
                setIsLoading(true);

                try {
                    const response = await axios.post(`${API_URL}/query`, {
                        query: input,
                        document_ids: searchMode === 'selected' ? selectedDocuments : null,
                        search_mode: searchMode,
                        top_k: 10
                    });

                    const assistantMessage = {
                        role: 'assistant',
                        content: response.data.answer,
                        sources: response.data.sources,
                        confidence: response.data.confidence,
                        documents_used: response.data.documents_used,
                        timestamp: new Date()
                    };

                    setMessages(prev => [...prev, assistantMessage]);
                } catch (error) {
                    setMessages(prev => [...prev, {
                        role: 'assistant',
                        content: 'Error processing your request. Please try again.',
                        isError: true,
                        timestamp: new Date()
                    }]);
                } finally {
                    setIsLoading(false);
                }
            };

            const handleFileUpload = async (event) => {
                const file = event.target.files[0];
                if (!file) return;

                setIsUploading(true);
                const formData = new FormData();
                formData.append('file', file);

                try {
                    const response = await axios.post(`${API_URL}/upload`, formData, {
                        headers: { 'Content-Type': 'multipart/form-data' }
                    });

                    setMessages(prev => [...prev, {
                        role: 'assistant',
                        content: `✅ Uploaded "${file.name}" - ${response.data.chunks_created} chunks created.`,
                        timestamp: new Date()
                    }]);
                    
                    await loadDocuments();
                } catch (error) {
                    setMessages(prev => [...prev, {
                        role: 'assistant',
                        content: `❌ Failed to upload "${file.name}".`,
                        isError: true,
                        timestamp: new Date()
                    }]);
                } finally {
                    setIsUploading(false);
                    event.target.value = '';
                }
            };

            const handleDeleteDocument = async (docId, docName) => {
                if (!confirm(`Delete "${docName}"?`)) return;

                try {
                    await axios.delete(`${API_URL}/documents/${docId}`);
                    setMessages(prev => [...prev, {
                        role: 'assistant',
                        content: `🗑️ Deleted "${docName}"`,
                        timestamp: new Date()
                    }]);
                    setSelectedDocuments(prev => prev.filter(id => id !== docId));
                    await loadDocuments();
                } catch (error) {
                    setMessages(prev => [...prev, {
                        role: 'assistant',
                        content: `❌ Failed to delete "${docName}"`,
                        isError: true,
                        timestamp: new Date()
                    }]);
                }
            };

            const toggleDocumentSelection = (docId) => {
                setSelectedDocuments(prev => 
                    prev.includes(docId) ? prev.filter(id => id !== docId) : [...prev, docId]
                );
            };

            const toggleSources = (messageIndex) => {
                setShowSources(prev => ({ ...prev, [messageIndex]: !prev[messageIndex] }));
            };

            const selectAllDocuments = () => {
                setSelectedDocuments(uploadedDocuments.map(doc => doc.document_id));
            };

            const clearSelection = () => {
                setSelectedDocuments([]);
            };

            return (
                <div className="flex h-screen bg-gray-50">
                    {/* Sidebar */}
                    <div className="w-80 bg-white border-r border-gray-200 flex flex-col">
                        <div className="p-6 border-b border-gray-200">
                            <h1 className="text-2xl font-bold text-gray-800">Multi-Doc AI</h1>
                            <p className="text-sm text-gray-600 mt-1">Intelligent Document Analysis</p>
                        </div>

                        <div className="p-4 border-b border-gray-200">
                            <button
                                onClick={() => fileInputRef.current?.click()}
                                disabled={isUploading}
                                className="w-full bg-indigo-600 text-white py-2 px-4 rounded-lg hover:bg-indigo-700 transition-colors flex items-center justify-center gap-2 disabled:opacity-50"
                            >
                                {isUploading ? (
                                    <>
                                        <svg className="w-4 h-4 spinner" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                            <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                                            <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                        </svg>
                                        <span>Uploading...</span>
                                    </>
                                ) : (
                                    <>
                                        <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                                        </svg>
                                        <span>Upload Document</span>
                                    </>
                                )}
                            </button>
                            <input
                                ref={fileInputRef}
                                type="file"
                                onChange={handleFileUpload}
                                accept=".pdf,.docx,.jpg,.jpeg,.png"
                                className="hidden"
                            />
                        </div>

                        {/* Search Mode */}
                        <div className="p-4 border-b border-gray-200 bg-gray-50">
                            <label className="text-xs font-semibold text-gray-700 mb-2 block">Search Mode</label>
                            <div className="flex gap-2">
                                <button
                                    onClick={() => setSearchMode('all')}
                                    className={`flex-1 py-2 px-3 rounded text-sm font-medium transition-colors ${
                                        searchMode === 'all'
                                            ? 'bg-indigo-600 text-white'
                                            : 'bg-white text-gray-700 border border-gray-300 hover:bg-gray-50'
                                    }`}
                                >
                                    All Docs
                                </button>
                                <button
                                    onClick={() => setSearchMode('selected')}
                                    className={`flex-1 py-2 px-3 rounded text-sm font-medium transition-colors ${
                                        searchMode === 'selected'
                                            ? 'bg-indigo-600 text-white'
                                            : 'bg-white text-gray-700 border border-gray-300 hover:bg-gray-50'
                                    }`}
                                >
                                    Selected
                                </button>
                            </div>
                        </div>

                        <div className="flex-1 overflow-y-auto p-4">
                            <div className="flex items-center justify-between mb-3">
                                <h3 className="text-sm font-semibold text-gray-700">
                                    Documents ({uploadedDocuments.length})
                                </h3>
                                {uploadedDocuments.length > 0 && (
                                    <div className="flex gap-1">
                                        <button
                                            onClick={selectAllDocuments}
                                            className="text-xs text-indigo-600 hover:text-indigo-800"
                                        >
                                            All
                                        </button>
                                        <span className="text-gray-400">|</span>
                                        <button
                                            onClick={clearSelection}
                                            className="text-xs text-indigo-600 hover:text-indigo-800"
                                        >
                                            None
                                        </button>
                                    </div>
                                )}
                            </div>
                            
                            {uploadedDocuments.length === 0 ? (
                                <p className="text-sm text-gray-500">No documents uploaded</p>
                            ) : (
                                <div className="space-y-2">
                                    {uploadedDocuments.map(doc => (
                                        <div
                                            key={doc.document_id}
                                            className={`p-3 rounded-lg border cursor-pointer transition-all ${
                                                selectedDocuments.includes(doc.document_id)
                                                    ? 'border-indigo-500 bg-indigo-50'
                                                    : 'border-gray-200 hover:border-gray-300 bg-white'
                                            }`}
                                        >
                                            <div 
                                                className="flex items-start justify-between"
                                                onClick={() => toggleDocumentSelection(doc.document_id)}
                                            >
                                                <div className="flex-1 min-w-0">
                                                    <p className="text-sm font-medium text-gray-800 truncate">
                                                        {doc.document_name}
                                                    </p>
                                                    <p className="text-xs text-gray-500 mt-1">
                                                        {doc.chunks_created} chunks
                                                    </p>
                                                </div>
                                                <input
                                                    type="checkbox"
                                                    checked={selectedDocuments.includes(doc.document_id)}
                                                    onChange={() => {}}
                                                    className="mt-1 text-indigo-600 rounded"
                                                />
                                            </div>
                                            <button
                                                onClick={(e) => {
                                                    e.stopPropagation();
                                                    handleDeleteDocument(doc.document_id, doc.document_name);
                                                }}
                                                className="mt-2 text-xs text-red-600 hover:text-red-800"
                                            >
                                                🗑️ Delete
                                            </button>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>

                        {searchMode === 'selected' && selectedDocuments.length > 0 && (
                            <div className="p-4 border-t border-gray-200 bg-indigo-50">
                                <p className="text-sm text-indigo-700">
                                    Searching {selectedDocuments.length} document{selectedDocuments.length > 1 ? 's' : ''}
                                </p>
                            </div>
                        )}
                    </div>

                    {/* Chat Area */}
                    <div className="flex-1 flex flex-col">
                        <div className="flex-1 overflow-y-auto p-6">
                            <div className="max-w-4xl mx-auto space-y-4">
                                {messages.map((message, index) => (
                                    <div
                                        key={index}
                                        className={`flex ${message.role === 'user' ? 'justify-end' : 'justify-start'} message-appear`}
                                    >
                                        <div className="max-w-2xl">
                                            <div className={`rounded-lg px-4 py-3 ${
                                                message.role === 'user'
                                                    ? 'bg-indigo-600 text-white'
                                                    : message.isError
                                                    ? 'bg-red-50 text-red-800 border border-red-200'
                                                    : 'bg-white border border-gray-200'
                                            }`}>
                                                <p className="text-sm whitespace-pre-wrap">{message.content}</p>
                                                
                                                {message.documents_used && message.documents_used.length > 0 && (
                                                    <div className="mt-2 pt-2 border-t border-gray-200">
                                                        <p className="text-xs text-gray-600 font-medium">
                                                            📚 Sources: {message.documents_used.join(', ')}
                                                        </p>
                                                    </div>
                                                )}
                                                
                                                {message.sources && message.sources.length > 0 && (
                                                    <div className="mt-3 pt-3 border-t border-gray-200">
                                                        <button
                                                            onClick={() => toggleSources(index)}
                                                            className="text-xs text-indigo-600 hover:text-indigo-800 font-medium"
                                                        >
                                                            {showSources[index] ? 'Hide' : 'Show'} Details ({message.sources.length})
                                                        </button>
                                                        
                                                        {showSources[index] && (
                                                            <div className="mt-2 space-y-2">
                                                                {message.sources.map((source, sIndex) => (
                                                                    <div key={sIndex} className="text-xs bg-gray-50 p-2 rounded">
                                                                        <p className="font-medium text-gray-700">
                                                                            {source.document_name} - Page {source.page}
                                                                        </p>
                                                                        <p className="text-gray-600 mt-1">
                                                                            Type: {source.type} | Score: {(source.relevance_score * 100).toFixed(1)}%
                                                                        </p>
                                                                        <p className="text-gray-500 mt-1 italic">
                                                                            {source.excerpt}
                                                                        </p>
                                                                    </div>
                                                                ))}
                                                            </div>
                                                        )}
                                                    </div>
                                                )}
                                                
                                                {message.confidence && (
                                                    <div className="mt-2 flex items-center gap-2">
                                                        <div className="flex-1 bg-gray-200 rounded-full h-2">
                                                            <div 
                                                                className="bg-indigo-600 h-2 rounded-full"
                                                                style={{ width: `${message.confidence * 100}%` }}
                                                            ></div>
                                                        </div>
                                                        <span className="text-xs text-gray-600">
                                                            {(message.confidence * 100).toFixed(1)}%
                                                        </span>
                                                    </div>
                                                )}
                                            </div>
                                            <p className="text-xs text-gray-500 mt-1 px-1">
                                                {new Date(message.timestamp).toLocaleTimeString()}
                                            </p>
                                        </div>
                                    </div>
                                ))}
                                
                                {isLoading && (
                                    <div className="flex justify-start message-appear">
                                        <div className="bg-white border border-gray-200 rounded-lg px-4 py-3">
                                            <div className="flex space-x-2">
                                                <div className="w-2 h-2 bg-indigo-600 rounded-full animate-bounce"></div>
                                                <div className="w-2 h-2 bg-indigo-600 rounded-full animate-bounce" style={{animationDelay: '0.2s'}}></div>
                                                <div className="w-2 h-2 bg-indigo-600 rounded-full animate-bounce" style={{animationDelay: '0.4s'}}></div>
                                            </div>
                                        </div>
                                    </div>
                                )}
                                
                                <div ref={messagesEndRef} />
                            </div>
                        </div>

                        {/* Input */}
                        <div className="border-t border-gray-200 bg-white p-4">
                            <div className="max-w-4xl mx-auto">
                                <div className="flex gap-3">
                                    <input
                                        type="text"
                                        value={input}
                                        onChange={(e) => setInput(e.target.value)}
                                        onKeyPress={(e) => e.key === 'Enter' && handleSendMessage()}
                                        placeholder="Ask about your documents..."
                                        className="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                        disabled={isLoading}
                                    />
                                    <button
                                        onClick={handleSendMessage}
                                        disabled={!input.trim() || isLoading}
                                        className="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors disabled:opacity-50"
                                    >
                                        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                                        </svg>
                                    </button>
                                </div>
                                <p className="text-xs text-gray-500 mt-2">
                                    {searchMode === 'all' 
                                        ? `Searching across all ${uploadedDocuments.length} documents`
                                        : `Searching in ${selectedDocuments.length} selected document(s)`
                                    }
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<MultiDocChatbot />, document.getElementById('root'));
    </script>
</body>
</html>