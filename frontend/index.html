<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Intelligent Document Chatbot</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <style>
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .spinner {
            animation: spin 1s linear infinite;
        }
        
        .message-appear {
            animation: slideUp 0.3s ease-out;
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .typing-indicator span {
            display: inline-block;
            width: 8px;
            height: 8px;
            background-color: #6366f1;
            border-radius: 50%;
            margin: 0 2px;
            animation: typing 1.4s infinite;
        }
        
        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
                opacity: 0.4;
            }
            30% {
                transform: translateY(-10px);
                opacity: 1;
            }
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect } = React;

        const API_URL = 'http://localhost:8000';

        function DocumentChatbot() {
            const [messages, setMessages] = useState([
                { 
                    role: 'assistant', 
                    content: 'Hello! I can help you analyze and understand technical documents. Upload documents or ask me questions about already uploaded content.',
                    timestamp: new Date()
                }
            ]);
            const [input, setInput] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const [uploadedDocuments, setUploadedDocuments] = useState([]);
            const [selectedDocuments, setSelectedDocuments] = useState([]);
            const [isUploading, setIsUploading] = useState(false);
            const [showSources, setShowSources] = useState({});
            
            const fileInputRef = useRef(null);
            const messagesEndRef = useRef(null);

            const scrollToBottom = () => {
                messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
            };

            useEffect(() => {
                scrollToBottom();
            }, [messages]);

            const handleSendMessage = async () => {
                if (!input.trim() || isLoading) return;

                const userMessage = {
                    role: 'user',
                    content: input,
                    timestamp: new Date()
                };

                setMessages(prev => [...prev, userMessage]);
                setInput('');
                setIsLoading(true);

                try {
                    const response = await axios.post(`${API_URL}/query`, {
                        query: input,
                        document_ids: selectedDocuments.length > 0 ? selectedDocuments : null,
                        top_k: 10
                    });

                    const assistantMessage = {
                        role: 'assistant',
                        content: response.data.answer,
                        sources: response.data.sources,
                        confidence: response.data.confidence,
                        timestamp: new Date()
                    };

                    setMessages(prev => [...prev, assistantMessage]);
                } catch (error) {
                    const errorMessage = {
                        role: 'assistant',
                        content: 'Sorry, I encountered an error processing your request. Please try again.',
                        isError: true,
                        timestamp: new Date()
                    };
                    setMessages(prev => [...prev, errorMessage]);
                } finally {
                    setIsLoading(false);
                }
            };

            const handleFileUpload = async (event) => {
                const file = event.target.files[0];
                if (!file) return;

                setIsUploading(true);
                const formData = new FormData();
                formData.append('file', file);

                try {
                    const response = await axios.post(`${API_URL}/upload`, formData, {
                        headers: {
                            'Content-Type': 'multipart/form-data'
                        }
                    });

                    const newDoc = {
                        id: response.data.document_id,
                        name: response.data.document_name,
                        chunks: response.data.chunks_created,
                        uploadTime: new Date()
                    };

                    setUploadedDocuments(prev => [...prev, newDoc]);
                    
                    const successMessage = {
                        role: 'assistant',
                        content: `Successfully uploaded "${file.name}". The document has been processed into ${response.data.chunks_created} searchable chunks.`,
                        timestamp: new Date()
                    };
                    setMessages(prev => [...prev, successMessage]);
                } catch (error) {
                    const errorMessage = {
                        role: 'assistant',
                        content: `Failed to upload "${file.name}". Please try again.`,
                        isError: true,
                        timestamp: new Date()
                    };
                    setMessages(prev => [...prev, errorMessage]);
                } finally {
                    setIsUploading(false);
                    event.target.value = '';
                }
            };

            const toggleDocumentSelection = (docId) => {
                setSelectedDocuments(prev => 
                    prev.includes(docId) 
                        ? prev.filter(id => id !== docId)
                        : [...prev, docId]
                );
            };

            const toggleSources = (messageIndex) => {
                setShowSources(prev => ({
                    ...prev,
                    [messageIndex]: !prev[messageIndex]
                }));
            };

            const formatTimestamp = (date) => {
                return new Date(date).toLocaleTimeString('en-US', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
            };

            return (
                <div className="flex h-screen bg-gray-50">
                    {/* Sidebar */}
                    <div className="w-80 bg-white border-r border-gray-200 flex flex-col">
                        <div className="p-6 border-b border-gray-200">
                            <h1 className="text-2xl font-bold text-gray-800">Document AI</h1>
                            <p className="text-sm text-gray-600 mt-1">Intelligent Document Analysis</p>
                        </div>

                        <div className="p-4 border-b border-gray-200">
                            <button
                                onClick={() => fileInputRef.current?.click()}
                                disabled={isUploading}
                                className="w-full bg-indigo-600 text-white py-2 px-4 rounded-lg hover:bg-indigo-700 transition-colors flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
                            >
                                {isUploading ? (
                                    <>
                                        <svg className="w-4 h-4 spinner" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                            <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                                            <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                        </svg>
                                        <span>Uploading...</span>
                                    </>
                                ) : (
                                    <>
                                        <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                                        </svg>
                                        <span>Upload Document</span>
                                    </>
                                )}
                            </button>
                            <input
                                ref={fileInputRef}
                                type="file"
                                onChange={handleFileUpload}
                                accept=".pdf,.docx,.jpg,.jpeg,.png"
                                className="hidden"
                            />
                        </div>

                        <div className="flex-1 overflow-y-auto p-4">
                            <h3 className="text-sm font-semibold text-gray-700 mb-3">Uploaded Documents</h3>
                            {uploadedDocuments.length === 0 ? (
                                <p className="text-sm text-gray-500">No documents uploaded yet</p>
                            ) : (
                                <div className="space-y-2">
                                    {uploadedDocuments.map(doc => (
                                        <div
                                            key={doc.id}
                                            onClick={() => toggleDocumentSelection(doc.id)}
                                            className={`p-3 rounded-lg border cursor-pointer transition-all ${
                                                selectedDocuments.includes(doc.id)
                                                    ? 'border-indigo-500 bg-indigo-50'
                                                    : 'border-gray-200 hover:border-gray-300 bg-white'
                                            }`}
                                        >
                                            <div className="flex items-start justify-between">
                                                <div className="flex-1">
                                                    <p className="text-sm font-medium text-gray-800 truncate">
                                                        {doc.name}
                                                    </p>
                                                    <p className="text-xs text-gray-500 mt-1">
                                                        {doc.chunks} chunks
                                                    </p>
                                                </div>
                                                <input
                                                    type="checkbox"
                                                    checked={selectedDocuments.includes(doc.id)}
                                                    onChange={() => {}}
                                                    className="mt-1 text-indigo-600 rounded"
                                                />
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>

                        {selectedDocuments.length > 0 && (
                            <div className="p-4 border-t border-gray-200 bg-indigo-50">
                                <p className="text-sm text-indigo-700">
                                    {selectedDocuments.length} document{selectedDocuments.length > 1 ? 's' : ''} selected for search
                                </p>
                            </div>
                        )}
                    </div>

                    {/* Chat Area */}
                    <div className="flex-1 flex flex-col">
                        {/* Messages */}
                        <div className="flex-1 overflow-y-auto p-6">
                            <div className="max-w-4xl mx-auto space-y-4">
                                {messages.map((message, index) => (
                                    <div
                                        key={index}
                                        className={`flex ${message.role === 'user' ? 'justify-end' : 'justify-start'} message-appear`}
                                    >
                                        <div className={`max-w-2xl ${message.role === 'user' ? 'order-1' : 'order-2'}`}>
                                            <div className={`rounded-lg px-4 py-3 ${
                                                message.role === 'user'
                                                    ? 'bg-indigo-600 text-white'
                                                    : message.isError
                                                    ? 'bg-red-50 text-red-800 border border-red-200'
                                                    : 'bg-white border border-gray-200'
                                            }`}>
                                                <p className="text-sm whitespace-pre-wrap">{message.content}</p>
                                                
                                                {message.sources && message.sources.length > 0 && (
                                                    <div className="mt-3 pt-3 border-t border-gray-200">
                                                        <button
                                                            onClick={() => toggleSources(index)}
                                                            className="text-xs text-indigo-600 hover:text-indigo-800 font-medium"
                                                        >
                                                            {showSources[index] ? 'Hide' : 'Show'} Sources ({message.sources.length})
                                                        </button>
                                                        
                                                        {showSources[index] && (
                                                            <div className="mt-2 space-y-1">
                                                                {message.sources.map((source, sIndex) => (
                                                                    <div key={sIndex} className="text-xs text-gray-600 flex items-center gap-2">
                                                                        <span className="inline-block w-2 h-2 bg-indigo-400 rounded-full"></span>
                                                                        <span>{source.document} - Page {source.page}</span>
                                                                        <span className="text-gray-400">({(source.relevance_score * 100).toFixed(1)}% match)</span>
                                                                    </div>
                                                                ))}
                                                            </div>
                                                        )}
                                                    </div>
                                                )}
                                                
                                                {message.confidence && (
                                                    <div className="mt-2 flex items-center gap-2">
                                                        <div className="flex-1 bg-gray-200 rounded-full h-2">
                                                            <div 
                                                                className="bg-indigo-600 h-2 rounded-full"
                                                                style={{ width: `${message.confidence * 100}%` }}
                                                            ></div>
                                                        </div>
                                                        <span className="text-xs text-gray-600">
                                                            {(message.confidence * 100).toFixed(1)}% confident
                                                        </span>
                                                    </div>
                                                )}
                                            </div>
                                            <p className="text-xs text-gray-500 mt-1 px-1">
                                                {formatTimestamp(message.timestamp)}
                                            </p>
                                        </div>
                                    </div>
                                ))}
                                
                                {isLoading && (
                                    <div className="flex justify-start message-appear">
                                        <div className="bg-white border border-gray-200 rounded-lg px-4 py-3">
                                            <div className="typing-indicator">
                                                <span></span>
                                                <span></span>
                                                <span></span>
                                            </div>
                                        </div>
                                    </div>
                                )}
                                
                                <div ref={messagesEndRef} />
                            </div>
                        </div>

                        {/* Input Area */}
                        <div className="border-t border-gray-200 bg-white p-4">
                            <div className="max-w-4xl mx-auto">
                                <div className="flex gap-3">
                                    <input
                                        type="text"
                                        value={input}
                                        onChange={(e) => setInput(e.target.value)}
                                        onKeyPress={(e) => e.key === 'Enter' && handleSendMessage()}
                                        placeholder="Ask a question about your documents..."
                                        className="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                        disabled={isLoading}
                                    />
                                    <button
                                        onClick={handleSendMessage}
                                        disabled={!input.trim() || isLoading}
                                        className="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                                    >
                                        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                                        </svg>
                                    </button>
                                </div>
                                <p className="text-xs text-gray-500 mt-2">
                                    Supported formats: PDF, DOCX, JPG, PNG • Max file size: 50MB
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<DocumentChatbot />, document.getElementById('root'));
    </script>
</body>
</html>